{"version":3,"file":"alpine-ajax.js","sources":["../src/utils/request.js","../src/index.js","../builds/cdn.js"],"sourcesContent":["export function request(method, url, data, options) {\n\n  if (method === 'GET') {\n    let params = Array.from(data.entries())\n      .filter(([key, value]) => value !== '' || value !== null)\n    if (params.length) {\n      let splitUrl = url.split('#')\n      let anchor = splitUrl[1]\n      url = splitUrl[0]\n      if (url.includes('?')) {\n          url += '?'\n      } else {\n          url += '&'\n      }\n      url += new URLSearchParams(params)\n      if (anchor) {\n          url += '#' + anchor\n      }\n    }\n    data = null\n  }\n\n  return new Promise((resolve, reject) => {\n    let xhr = new XMLHttpRequest()\n    xhr.open(method, url)\n    xhr.overrideMimeType('text/html')\n\n    let headers = Object.assign({\n      'X-Requested-With': 'XMLHttpRequest',\n      'X-Alpine-Request': 'true',\n    }, options.headers)\n\n    for (const [key, value] of Object.entries(headers)) {\n      xhr.setRequestHeader(key, value)\n    }\n\n    if (options.progress && xhr.upload) {\n      xhr.upload.addEventListener('progress', options.progress)\n    }\n\n    let info = { xhr, url, data, options }\n\n    xhr.onload = function () {\n      if (this.status >= 200 && this.status < 400) return resolve(xhr.response)\n\n      reject(info)\n    }\n\n    xhr.onerror = function () {\n      reject(info)\n    }\n\n    xhr.send(data)\n  })\n}\n","import { request } from './utils/request'\n\nlet trigger = null\n\nexport default function (Alpine) {\n  Alpine.addRootSelector(() => '[x-ajax]')\n\n  Alpine.directive('ajax', (el, { expression }, { cleanup, evaluateLater, effect }) => {\n    expression = expression === '' ? '{}' : expression\n    let evaluate = evaluateLater(expression)\n\n    let removeTriggerListener = () => {}\n    if (el.tagName === 'FORM') {\n      removeTriggerListener = on(el, 'click', event => { trigger = event.target })\n    }\n\n    let options = {}\n    let removeDynamicListener = () => {}\n    effect(() => {\n      evaluate(values => {\n        removeDynamicListener()\n        options = ajaxOptions(el, values)\n        removeDynamicListener = on(el, options.event, async event => {\n          event.preventDefault()\n          let fragment = await sendRequest(options)\n          if (fragment) {\n            let action = insertActions(fragment, options.target)[options.insert]\n            if (! action) {\n              throw Error(`Invalid insert action. Available actions are: ${Object.keys(insertActions()).join(', ')}`)\n            }\n            return Alpine.mutateDom(action)\n          }\n        })\n      })\n    })\n\n    cleanup(() => {\n      removeTriggerListener()\n      removeDynamicListener()\n      trigger = null\n    })\n  })\n}\n\nfunction on(el, event, handler) {\n  el.addEventListener(event, handler)\n\n  return () => {\n    el.removeEventListener(event, handler)\n  }\n}\n\nfunction ajaxOptions(el, values = {}) {\n  let defaults = {\n    event: el.tagName === 'FORM' ? 'submit' : 'click',\n    action: window.location.href,\n    method: 'GET',\n    target: el,\n    insert: 'update',\n  }\n\n  let options = Object.assign(defaults, values)\n  options.method = el.getAttribute('method') || options.method\n  options.method = options.method.toUpperCase()\n  options.action = el.getAttribute('action') || options.action\n  if (isLocalLink(el)) {\n    options.action = el.getAttribute('href') || options.action\n  }\n  if (typeof options.target === 'string') {\n    options.target = document.querySelector(options.target)\n  }\n  options.data = getFormData(options.data ?? el)\n\n  return options\n}\n\nfunction isLocalLink(el) {\n  return el.tagName === 'A' &&\n    location.hostname === el.hostname &&\n    el.getAttribute('href') &&\n    el.getAttribute('href').indexOf(\"#\") !== 0\n}\n\nfunction getFormData(data) {\n  return data.tagName === 'FORM' ? new FormData(data) : valuesToFormData(data)\n}\n\nfunction valuesToFormData(values) {\n  let formData = new FormData();\n  for (let name in values) {\n    if (values.hasOwnProperty(name)) {\n      let value = values[name];\n      if (Array.isArray(value)) {\n        forEach(value, function(v) {\n          formData.append(name, v);\n        });\n      } else {\n        formData.append(name, value);\n      }\n    }\n  }\n\n  return formData;\n}\n\nasync function sendRequest(options) {\n  if (options.confirm && !confirm(options.confirm)) return;\n\n  if (trigger && trigger.name) {\n    options.data.append(trigger.name, trigger.value)\n  }\n\n  let response = null\n  try {\n    response = await request(options.method, options.action, options.data, options)\n  } catch (response) {\n    throw Error(response.xhr.statusText)\n  }\n\n  let fragment = textToFragment(response)\n\n  if (options.select) {\n    return fragment.querySelector(options.select)\n  }\n\n  return fragment\n}\n\nfunction textToFragment(text) {\n  return document.createRange().createContextualFragment(text);\n}\n\nfunction insertActions(fragment, target) {\n  return {\n    after() {\n      target?.parentElement?.insertBefore(fragment, target.nextSibling)\n    },\n    append() {\n      target?.append(fragment)\n    },\n    before() {\n      target?.parentElement?.insertBefore(fragment, target)\n    },\n    prepend() {\n      target?.prepend(fragment)\n    },\n    replace() {\n      if (target?.tagName === 'BODY') {\n        return insertActions(fragment, target).update()\n      }\n      target?.replaceWith(fragment)\n    },\n    update() {\n      if (target) {\n        target.innerHTML = ''\n        target.append(fragment)\n      }\n    }\n  }\n}\n","import ajax from '../src/index'\n\ndocument.addEventListener('alpine:initializing', () => {\n    ajax(window.Alpine)\n})\n"],"names":["request","method","url","data","options","params","Array","from","entries","filter","key","value","length","splitUrl","split","anchor","includes","URLSearchParams","Promise","resolve","reject","xhr","XMLHttpRequest","open","overrideMimeType","headers","Object","assign","setRequestHeader","progress","upload","addEventListener","info","onload","status","response","onerror","send","trigger","Alpine","addRootSelector","directive","el","expression","cleanup","evaluateLater","effect","evaluate","removeTriggerListener","tagName","on","event","target","removeDynamicListener","values","ajaxOptions","preventDefault","fragment","sendRequest","action","insertActions","insert","Error","keys","join","mutateDom","handler","removeEventListener","defaults","window","location","href","getAttribute","toUpperCase","isLocalLink","document","querySelector","getFormData","hostname","indexOf","FormData","valuesToFormData","formData","name","hasOwnProperty","isArray","forEach","v","append","confirm","statusText","textToFragment","select","text","createRange","createContextualFragment","after","parentElement","insertBefore","nextSibling","before","prepend","replace","update","replaceWith","innerHTML","ajax"],"mappings":"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"}